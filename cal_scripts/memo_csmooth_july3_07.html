<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="content-type">
  <title>memo_cal.html</title>
  <meta content="Daniel Wang" name="author">
</head>
<body>
<pre>;Analysis procedure using the CIAO csmooth<br>;=============================================================================<br>; written by wqd, June 7, 2007<br>;=============================================================================<br>CSMOOTH can only be applied to a count map. The routine treats point-like<br>sources well and limits their effects on the smoothing of diffuse emission.<br>In default, S/N is evalued with the background calculated locally. For a point-like source, such<br>a calculation is well defined, but is problematic for extended features such<br>as a filament. This is why the routine tends to oversmooth the data. The <br>smoothing is generally good for the overall large-scale diffuse emission<br>(e.g., around a galaxy), where the local background is again relatively well<br>defined. The calculation is also problematic at edges of exposures or CCD gaps, where<br>the local background is artificially low (the routine does not know how the expsoure<br>abruptly changes. As a result, noise can be amplified.<br><br>Alternatively, one can provide a background map (e.g., a stow particle<br>background map or an off-target background flux multipled by the exposure map). In this <br>case, the S/N is calucated from the excess above this map. Presumably, the background <br>intensity is also weighted with the same kernel as for the data (but I am not<br>100% sure). The advantage of this calculation is that the edge or gap effect<br>should be minimal and that the background is relatively well-defined <br>for diffuse emission. As a result, filamental features are less over-smoothed.<br>Here the so-called signal is clearly greater than that above the local<br>background. Therefore, to achieve the same smoothness of the local scale<br>diffuse emission, one needs a considerably higher sigmin (e.g., =3 or greater). But <br>point-like sources (where the noise is not mainly from the background) would<br>be oversmoothed.<br><br>In summary, the local background approach is good for smoothing a map with sources<br>and for showing the overall large-scale <br>diffuse emission, but only in an image with no<br>abrupt change of exposure. The user-supplied background approach is good<br>for smoothing diffuse emission in a source-removed image.<br>;=============================================================================<br>;Setup the images for the smoothing (in IDL and in the directory imaging/dif):<br>instr='aciss'<br>;set the instrument environment:<br>; (even if you restore from a idlsave.dat file, you still need to run this)<br>cenvset,instr <br>;-------------------<br>;read in the event list<br>gradec=[140.510975,50.976519] ;for N2841 galaxy center, change accrordingly!!!<br>;csmooth for images with sources:<br>block=2 &amp; imdim=[1,1]*512 &amp; imccd=[7] ;for aciss<br>expfhead=evtroot+'_ccd7_i' ;for special exposure map; default expfhead=evtroot+'_i' for imccd=[6,7,8])<br>;block=6 &amp; imdim=512 &amp; imccd=[0,1,2,3] ;for acisi<br>trans=(60./(block*!size_pixel))^2*1.e2<br>evtroot='evt2file_new_clean' ;default file name root<br>maindir='../../'<br>fdir=maindir+'xdata/'<br>soufile=maindir+'sou/evt2file_new_clean_map70BSH_hr'<br>;================================================================================<br>;<span
 style="font-weight: bold;">csmooth images with sources (with fits image output):</span><br>evt_image,evtroot,instr,ca,ta,ba=ba,datadir=fdir,hdr=mh,expfhead=expfhead,xmin=xmin,ymin=ymin,bmin=bmin,bmax=bmax,imb=block,list=mlist,gradec=gradec,imdim=imdim,imccd=imccd,expt=expt<br><br>;------------------------<br>;In case that the background normalization is needed and differs from one chip to another:<br>;construct the background image chip by chip:<br><br>bnorm=[1.0181527,1] ;copied from running cal_background.pro (memo_bg) for the chip(s)<br>ba=ta*0.<br>for k=0,n_elements(imccd)-1 do begin &amp; evt_image,evtroot,instr,ba=a,datadir=fdir,hdr=mh,xmin=xmin,ymin=ymin,gradec=gradec,imdim=imdim,bfname='../../xdata/bevt2file_new_clean.fits',/bmaponly,/nofits,imccd=imccd(k) &amp; ba=ba+a*bnorm(k) &amp; endfor<br>for k=0,3 do begin &amp; writefits,'b_'+strtrim(k+1,2)+'.fits',ba(*,*,k),mh<br><br>;Do a simple gaussian smoothed intensity image to see if the produced images are OK:<br>g5=psf_gaussian(fwhm=10,/norm,npix=121)<br>tv,bscale(convolve(total(imdiv(ca-ba,ta),3),g5)*1.e3,0,0.01)<br><br>;fill the zero exposure regions with a median value to minimize artifical bumps produced by csmooth.<br>a=total(ca,3)<br>b=convolve(a,g5)<br>t=ta(*,*,0)<br>s=where(t le 0.,ns)<br>if ns ne 0 then a(s)=median(b(where(t gt 0)))<br>tv,bscale(a,0,1)<br>curval,a ;off regions should have a non-zero value<br>writefits,'c_b.fits',a,mh<br>;-----------------------<br>;in a separate window, run the ciao command in the same directory:<br>$PUBDIR/cal_scripts/mcsmooth.e "1 2 3 4" 2.5 3.5 1 &amp;<br>;------------------------<br>;Now read in the smoothed<br>t=readfits('t_4.fits')<br>edge=40<br>;edge=[44+10,44+40] ;;adjust accordingly to get rid of aliased edges and empty space<br>read_mimages,4,mh,fs,a,mv,cor=cor,edge=edge,mdim=mdim,bnorm=1,filter=t<br>;for 1, 2,3+4 bands<br>amv=-(mv(0))*0.8 ;such numerical values may be adjusted to reach a desirable contrast <br>a(*,*,0)=bscale(alog10(fs(*,*,0)+amv),alog10(mv(0)+amv),alog10((mv(0)+amv)*100))<br>amv=-mv(1)*0.8<br>a(*,*,1)=bscale(alog10(fs(*,*,1)+amv),alog10(mv(1)+amv),alog10((mv(1)+amv)*1000))<br>amv=-(mv(2)+mv(3))*0.8<br>a(*,*,2)=bscale(alog10(fs(*,*,2)+fs(*,*,3)+amv),alog10(mv(2)+mv(3)+amv),alog10((mv(2)+mv(3)+amv)*2000))<br>cont_grey,a,mh,cor=cor,true=3,mr=0,/ps,/nocon,/full,f_c=-1,barf=0. <br>scale='1''<br>scale_plot,cor,mh,0.08,0.94,1,scale,thick=2,char=cs,color=255<br> s=tvrd(0,0,true=3)<br>write_jpeg,'rgb.jpg',s,true=3,qua=100<br>;----------------------------- <br>;broad-band image plot:<br>fb=total(fs,3)<br>;If the image to be compared with has a pixel size similar to or greater than that of the X-ray image, the following may apply<br>cast,maindir+'mdata/dss2_blue.fits',mh,outa=o<br>;dss2_blue.fits can be extracted from http://skyview.gsfc.nasa.gov/cgi-bin/skvadvanced.pl (e.g., image size=0.16 deg)<br>;for ps output:<br>;set_plot,'ps'<br>;device,bits=8,/land,color=1,xsize=16.*imdim(0)/imdim(1),ysiz=16,yoff=26,xoff=2 <br>loadct_self,30<br>cont_grey,fb,mh,o-median(o),cor=cor,mr=0,/ps,/def,barf=0.,greymin=1.,greymax=1.2*max(o),greylo=2,lev=lev,c_c=255 ;/noim ;for contours only<br>device,/close<br>$gv idl.ps<br>;----------------------------- <br>;record the final contour levels (in units of 10^-3 cts/s/arcmin^2)<br>print,lev <br>;----------------------------- <br>;For a high-resolution optical images, we don't want to degrade it to the X-ray resolution. So we cast the X-ray image into the optical coordinates:<br>ha=readfits(maindir+'mdata/NGC_2841:I:B:kab2003.fits.gz',hah) ;B-band image<br>;first use the ds9 to have a look of the image and its header to see if everything (astrometry info) is all fine. Then probably redefine the FoV (e..g, to remove edges):<br>lo=[652,410] ;lower left cornor coordinates of the new image<br>mdim=[880,1224] ;the dimension<br>ha=ha(lo(0):lo(0)+mdim(0)-1,lo(1):lo(1)+mdim(1)-1)<br>get_fitshead,ha,shah,hah,cdim=lo,equi=2000 ;get a new header<br>cast,'',shah,outa=fbs,ina=fb,inh=mh ;cast the x-ray image to the new fov<br><br>swindow,xs=mdim(0),ys=mdim(1) ;for a very big image, use swindow instead of window<br>loadct_self,30<br>cor=[0,1,0,1]<br>cont_grey,fbs,shah,ha,cor=cor,mr=0,/ps,/def,barf=0.,greymin=0.4,greymax=200,greylo=1,lev=lev,c_c=255<br>;================================================================================<br>;================================================================================<br>;<span
 style="font-weight: bold;">csmooth for images of diffuse emission:</span><br>instr='aciss'<br>cenvset,instr <br>;-------------------<br>;read in the event list<br>gradec=[140.510975,50.976519] ;for N2841 galaxy center, change accrordingly!!!<br>;csmooth for images with sources:<br>block=2 &amp; imdim=[1,1]*512 &amp; imccd=[6,7] ;for aciss<br>;block=6 &amp; imdim=512 &amp; imccd=[0,1,2,3] ;for acisi<br>trans=(60./(block*!size_pixel))^2*1.e2<br>evtroot='evt2file_new_clean' ;default file name root<br>fdir='../../xdata/'<br>soufile='../../sou/evt2file_new_clean_map70BSH_hr'<br>; first get the event list (with no fits image output):<br>evt_image,evtroot,instr,ca,ta,datadir=fdir,hdr=mh,xmin=xmin,ymin=ymin,bmin=bmin,bmax=bmax,imb=block,list=mlist,gradec=gradec,imdim=imdim,imccd=imccd,expt=expt,/nofits<br>;---------------------<br>;remove source events<br>;subfac=2 ;def=1.5<br>list_sel,flist,mlist,msel,ftail='.fits',fdir=fdir,souf=soufile,subfac=subfac,eband=eband,flow=flow,fname=evtroot,filter=filter<br>smlist=mlist(msel)<br>;assuming that the diffuse is important only in the first 2 bands:<br>maxbn=1<br>emin=bmin(0) &amp; emax=bmax(maxbn)<br>list_image,smlist,xmin,ymin,cb,imdim(0),imdim(1),block=block,det=detagname,emin=emin,emax=emax<br>tv,bscale(cb,0,5)<br><br>csa=ca<br>for k=0,maxbn do begin list_image,smlist,xmin,ymin,cb,imdim(0),imdim(1),block=block,det=detagname,emin=bmin(k),emax=bmax(k) &amp; csa(*,*,k)=cb<br>;---------------------<br>;construct a source removing filter:<br>eband=1 ;does not matter which band; it is going to be normalized<br>cast_main,flist,mh,ts,ftail='_i',mtype=mtype,fdir=fdir,soufile=soufile,subfac=subfac,flow=flow,fname=evtroot,eband=eband,/noint ; ,/mtoi ;used when block is larger than 4 for acisi and 3 for aciss<br>cast_main,flist,mh,t,ftail='_i',mtype=mtype,fdir=fdir,fname=evtroot,eband=eband,/noint ;,/mtoi <br>;flist is used for multiple observations.<br>;---------------<br>; now apply the filter to exposure maps in individual bands:<br>tsa=ta<br>for k=0,maxbn do tsa(*,*,k)=tsa(*,*,k)*imdiv(ts,t)<br><br>;output the image files:<br>for k=0,maxbn do begin &amp; writefits,'c_'+strtrim(k+1,2)+'.fits',csa(*,*,k),mh &amp; writefits,'t_'+strtrim(k+1,2)+'.fits',tsa(*,*,k),mh &amp; endfor<br>writefits,'c_b.fits',total(csa(*,*,0:maxbn),3),mh<br>;-----------------------<br>;Now get the background event list (for multiple pointings, fidv needs to be provided; not tested yet!!!)<br>;You may first remove sources from individual observations and then use cast_main as for the exposure maps, as long as the <br>;the pixel size of the merged map is about sqrt(2) greater than that of individual images. <br>; The following approach is more general and can be used for close-ups at high resolution: <br>get_blist,maindir+'bevt2file_new_clean.fits',tblist,bexptv,imccd=imccd,fidv=fidv<br>list_sel,flist,tblist,msel,ftail='.fits',fdir=fdir,souf=soufile,subfac=subfac,eband=eband,flow=flow,fname=evtroot,filter=filter<br><br>;the following is yet to be extended to multiple pointnigs:<br>bn=float(expt/bexptv)*[1.1868013,1.0181527] ;copied from running cal_background.pro (memo_bg) for imccd<br>blist_image,ba,tblist(msel),bn,mh,xmin,ymin,bmin(0:1),bmax(0:1),block ;,fidv=fidv,/nofits<br>;background fits images have been produced. <br>;-----------------------<br>;in a separate window, run the ciao command in the same directory (notice the band number convetion difference):<br>$PUBDIR/cal_scripts/mcsmooth_b.e "1 2" 4. 5 1 &amp; <br>;------------------------<br>;Now read in the smoothed images in IDL:<br>t=ta(*,*,0) ;just as a filter<br>;edge=[44+10,44+40] <br>;edge=40 ;removing the edges of the smoothed image and adjust accordingly for an individual target<br>read_mimages,indgen(maxbn+1),mh,fs,a,mv,cor=cor,edge=edge,mdim=mdim,bnorm=1.,filter=t<br>;----------------------------<br>;broad band image plot:<br>fb=total(fs,3)<br>backf=0.9*median(fb) ;the coeficient may need to be adjusted to optimize the stretch <br>lev=backf*(1.+1./3.)^(indgen(20)+2) <br>;device,bits=8,/land,color=1,xsize=16.,ysiz=14,yoff=22,xoff=4<br>cor=[0,1,0,1]<br>cont_grey,fb-0.5*backf,mh,cor=cor,mr=0,/ps,/def,greymin=0.5*backf,greymax=50,greylo=1,lev=lev-0.5*backf,c_c=[lev(0:4)*0.+255,lev*0.],thre=lev(4)<br> source_plot,soufile,cor,mh,slow=0,probth=probth,psym=7.,sym=1.,/fits,s_c=!d.n_colors-1        <br>device,/close<br>$gv idl.ps &amp;<br>$mv idl.ps dif_c01.ps<br><br>tv,bscale(total(csa(*,*,0:maxbn),3),0,2)<br>;----------------------------<br>;for 3-color composite image (need to adjust):<br>amv=-(mv(0))*0.85 ;such numerical values may be adjusted to reach a desirable contrast <br>a(*,*,0)=bscale(alog10(fs(*,*,0)+amv),alog10(mv(0)+amv),alog10((mv(0)+amv)*100))<br>amv=-mv(1)*0.85<br>a(*,*,1)=bscale(alog10(fs(*,*,1)+amv),alog10(mv(1)+amv),alog10((mv(1)+amv)*1000))<br>amv=-(mv(2)+mv(3))*0.85<br>a(*,*,2)=bscale(alog10(fs(*,*,2)+fs(*,*,3)+amv),alog10(mv(2)+mv(3)+amv),alog10((mv(2)+mv(3)+amv)*2000))<br>cont_grey,a,mh,cor=cor,true=3,mr=0,/ps,/nocon,/full,f_c=-1,barf=0. <br>;=============================================================================<br>;Multi-wavelength comparison (N4841 galaxy):<br>maindir='../../'<br>ha=readfits(maindir+'mdata/NGC_2841:I:MIPS24:kab2003.fits.gz',hah) ;MIPC<br>xlo=140 &amp; ylo=220 <br>ha=ha(xlo:511,ylo:731)<br>get_fitshead,ha,shah,hah,del=0.000208333333333d,cpx=321.5-xlo,cpy= 481.5-ylo<br><br>cast,'',shah,outa=fbs,ina=fb,inh=mh<br>;device,bits=8,/land,color=1,xsize=12.,ysiz=14,yoff=22,xoff=4<br>cont_grey,fbs,shah,ha,cor=cor,mr=0,/ps,lev=lev,/def,barf=0.,greymin=0.3,greymax=10,greylo=1,thick=2,f_c=!d.n_colors-1,c_c=c_c,xuni=0.2<br>device,/close<br>$gv idl.ps &amp;<br><br>ha=readfits(maindir+'mdata/NGC_2841:I:NUV:g2006.fits.gz',hah)<br>shah=hah<br>cast,'',shah,outa=fbs,ina=fb,inh=mh<br>;device,bits=8,/land,color=1,xsize=12.,ysiz=14,yoff=22,xoff=4<br>cont_grey,fbs,shah,ha,cor=cor,mr=0,/ps,lev=lev,/def,barf=0.,greymin=0.01,greymax=0.5,greylo=1,thick=2,f_c=!d.n_colors-1,c_c=c_c,xuni=0.2<br>source_plot,soufile,cor,shah,slow=0,probth=probth,psym=7.,sym=1.,/fits,s_c=!d.n_colors-1        <br>device,/close<br>$gv idl.ps &amp;<br><br><br>;create a 2-color image<br>grey,ha,greymin=0.4,greylog=1,greymax=200,cor=cor,barf=0.,/ps<br>tv,bscale(alog10((fbs-1.0) &gt; 0.01),alog10(0.5),alog10(50.)),ch=2<br>;=============================================================================<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></pre>
</body>
</html>
