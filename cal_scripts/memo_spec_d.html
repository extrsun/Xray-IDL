<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="content-type">
  <title>memo_cal.html</title>
  <meta content="Daniel Wang" name="author">
</head>
<body>
<pre>;=========================================================================<br>#Requirements:<br># 1)  ciao and ftools are runnig<br># 2)  move to a directory called spec under MAINDIR as defined below<br>;=========================================================================<br>#first define the input event and output spectrum file root names:<br>set event_root=evt2file_new_clean<br>set spec_root=cluster<br><br>set MAINDIR=../<br>set datadir=$MAINDIR/xdata<br>set asphistfile=$MAINDIR/cal/${event_root}_asphist.fits<br>$PUBDIR/cal_scripts/assign_bpix.e $MAINDIR/cal/bpixfile.fits<br>set eventfile=${datadir}/${event_root}.fits<br>#===================================================================<br>#include only the interested ccds<br>#set ccd_id="7"<br>set ccd_id="0,1,2,3"<br>#set band="300:12000"<br><br>set source_reg=../sou/${event_root}_map70BSH_hr.reg<br>#---------------<br>#dmcopy "${eventfile}[grade=0,2,3,4,6][ccd_id=$ccd_id][energy=$band]" ${event_root}_s.fits clobber=yes<br>dmcopy "${eventfile}[grade=0,2,3,4,6][ccd_id=$ccd_id]" ${event_root}_s.fits clobber=yes<br><br>set eventfile=${event_root}_s.fits<br><br>#get only the diffuse emission<br>dmcopy "${eventfile}[exclude sky =region($source_reg)]" ${event_root}_sd.fits clobber=yes<br>set eventfile=${event_root}_sd.fits<br><br>#get corrresponding blank-sky data (see memo_back), used first by spec_weight.csh<br>#ds9  b${eventfile} &amp;<br>#dmcopy "../back/b${event_root}.fits[grade=0,2,3,4,6][ccd_id=$ccd_id][energy=$band]" b${event_root}_s.fits clobber=yes<br>dmcopy "../xdata/b${event_root}.fits[grade=0,2,3,4,6][ccd_id=$ccd_id]" b${event_root}_s.fits clobber=yes<br>#for ccd7 only<br>#dmcopy "../back/b${event_root}_ccd7.fits[grade=0,2,3,4,6][ccd_id=$ccd_id][energy=$band]" b${event_root}_s.fits clobber=yes<br><br>dmcopy "b${event_root}_s.fits[exclude sky =region($source_reg)]" b${event_root}_sd.fits clobber=yes<br>#===================================================================<br>set reg_s=${spec_root}.reg<br>set reg_b=${spec_root}_b.reg<br>#use ds9 to create a region file (def: ${spec_root}.reg) to define the source<br># and a background region (def: ${spec_root}_b.reg); saved in the ciao format.<br>#you may want to select the band to optimize the diffuse X-ray signal (e.g.) <br>dmcopy "${eventfile}[energy="300:1500"]" test.fits clobber=yes<br><br>ds9  test.fits &amp;<br>#===================================================================<br>#produce the weight map of the difuse source spectrum, the energy band may<br>#needs to be changed to maximize the S/N ratio of the interested emission.<br>#For hard diffuse emission such as a cluster, for example:<br>$PUBDIR/cal_scripts/spec_weight.csh "500:4000" "${spec_root}" "${event_root}_sd" "./"<br>#for soft diffuse emission such as the hot ISM (ACIS-S):<br> $PUBDIR/cal_scripts/spec_weight.csh "300:1500" "${spec_root}" "${event_root}_sd" "./"<br>#error might appear if the exposure for the backg data is not in the right<br>#format (e.g., 3.8E5). Check the file:<br>fv cluster.wmap<br>#===================================================================<br># do the steps separately:<br><br>punlearn dmextract<br>pset dmextract infile="${eventfile}[sky =region($reg_s)]"<br>pset dmextract outfile=${spec_root}_s.pi<br>pset dmextract opt=pha1<br>pset dmextract clobber=yes<br>pset dmextract mode=h<br>dmextract<br>mkwarf infile=${spec_root}.wmap outfile=${spec_root}.warf weightfile=${spec_root}.wfef spectrumfile="" egridspec="0.224004:11:0.01" clobber=yes<br>mkrmf infile="CALDB" outfile=${spec_root}.wrmf axis1=energy=0.224004:11.0:0.01 axis2=pi=1:1024:1 logfile=.psp.mlog weights=${spec_root}.wfef clobber=yes verbose=2<br><br># or do them together, although the low energy limit set in acisspec may be problematic<br>punlearn acisspec<br>pset acisspec soufile1="${eventfile}[sky=region($reg_s)]"<br>pset acisspec root=$spec_root<br>pset acisspec souwmap1=${spec_root}.wmap<br>pset acisspec mode=h<br>pset acisspec clobber = yes<br>acisspec verbose=2 <br>#===================================================================<br><br>#get the background spectrum with arf and rmf<br>punlearn dmextract<br>pset dmextract infile="${eventfile}[sky =region($reg_b)]"<br>pset dmextract outfile=${spec_root}_b.pi<br>pset dmextract opt=pha1<br>pset dmextract clobber=yes<br>pset dmextract mode=h<br>dmextract<br>#===================================================================<br>#If arf is produced with ciao later than v3.0.2, no need for the following:<br>#correct for the low energy sensitivity degration of the CCDs:<br>#http://cxc.harvard.edu/ciao/threads/apply_acisabs/<br>#correct for the ACIS sensitivity degration:<br>#ln -s /net1/hobby/software/ciao_3.0.2/contrib/bin/interpreted/acisabs.sl apply_acisabs<br>#punlearn apply_acisabs<br>#mv ${spec_root}_sou.warf ${spec_root}_sou_pre_abs.warf<br>#apply_acisabs ${spec_root}_sou_pre_abs.warf ${spec_root}_sou.warf<br><br>#===================================================================<br># The above method uses the off-source spectrum for the on-source background <br># subtraction. This is problematic for a large diffuse source. The off-source <br># region, which may be even in separate chips, can be significantly <br># different from the on-source region. To account for this background <br># differences, we possibly need to renormalize the off-source background spectrum<br># to make the on- and off-source spectra statistically consistent with each other.<br>;----------------------------------------------------------------------<br># First, we obtain the same on- and off-source spectra from the blank-sky<br># data. At this point (Jan 10, 2003) acisspec does not like the Maxim's <br># blank-ksy data files (see ticket answer). But the following is sufficient:<br><br>#on-source spectrum<br>punlearn dmextract<br>pset dmextract infile="b${event_root}_sd.fits[sky =region($reg_s)][bin pi=1:1024:1]"<br>pset dmextract outfile=b${spec_root}_s.pi<br>pset dmextract opt=pha1<br>pset dmextract clobber=yes<br>pset dmextract mode=h<br>dmextract<br><br>#If the off-source blank-sky spectrum is to be shared with a previous features, <br># you may, for example,<br>ln -s bcluster_b.pi b${spec_root}_b.pi<br>#With the link, you should not change the exposure; otherwise, you need to copy it.<br><br>#for a new off-source blank-sky spectrum<br>punlearn dmextract<br>pset dmextract infile="b${event_root}_sd.fits[sky =region($reg_b)][bin pi=1:1024:1]"<br>pset dmextract outfile=b${spec_root}_b.pi<br>pset dmextract opt=pha1<br>pset dmextract clobber=yes<br>pset dmextract mode=h<br>dmextract<br>;------------------------------------------------------------<br>#Second, find the normlization factor and check the statistical consistency:<br># In IDL:<br>;--------------------<br>spec_root='cluster' ;change the name accordingly!<br>bs_norm,'b'+spec_root+'_s.pi','b'+spec_root+'_b.pi',spec_root+'_sou.wrmf',bexpt,cbg,bbg,glo,ghi,eflo=[0.4],efhi=[7],psfile='spec_comp.ps',fnorm=fnorm<br><br># The file spec_root+'_sou.wrmf in the above program is used only for reading <br># the channel boundaries. Other wrmf for the same instrument will just be fine.<br># Check the output parameters "after norm: chi2,dof, and sigma =" to see if the fit<br># is acceptable (e.g., sigma &lt; 2 may be considered to be acceptable).<br># If a certain energy range (e.g., due to a strong line) causes a bad fit, you may<br># redefine eflo and efhi too exclude it from this check and subsequent spectral<br># fits.The printed value for the parameter "fnorm" should be used to correct for<br># (divide) the exposure of the background spectrum (e.g., ${spec_root}_b.ps):<br>fv  ${spec_root}_b.ps<br>#==========================================================================<br>#The above background subtraction approach (#1) may be the simplest for a diffuse<br># source spectral analysis, but may not work. Here are several situations I have <br>#considered:<br><br>Approach #2:<br> When no suitable off-source background region can be found (e.g., a galaxy<br>fills the intire chip 7), one may use the on-source blank-sky spectrum as<br>an estimate of the background. But we may normalize the blank-sky spectrum<br>if an energy range is not contaminated by the source (e.g., the diffuse halo <br>thermal X-ray emission around a spiral galaxy is very much confined in the <br>&lt; 2 keV range. We can then try to match the two on-source spectra in this<br>energy range. For example,<br><br>bs_norm,spec_root+'_sou.pi','b'+spec_root+'_s.pi',spec_root+'_sou.wrmf',bexpt,cbg,bbg,glo,ghi,eflo=[3.],efhi=[7.],psfile='spec_comp.ps',fnorm=fnorm<br><br>#The potential problem with this approach is that we have to make the assumption<br>#that the similarity of the spectral shapes extends to the energy range that is<br>#not used in the fit and is where the diffuse spectral analysis is to be carried <br>#out. This may not be a good assumption. But this may be the only choice.<br>;------------------------------------------------------------<br>Approach #3:<br>If the on- and off-source spectra in approach 1 are quite different (a case <br>that I have not met), the simple normalization does not work. In this case, <br>one may try the renormalization similar to approach 1. But here you fit the two <br>off-source spectra. using the IDL program:<br><br>bs_norm,spec_root+'_b_sou.pi','b'+spec_root+'_b.pi',spec_root+'_sou.wrmf',bexpt,cbg,bbg,glo,ghi,eflo=[0.4],efhi=[7.],psfile='spec_ref_comp.ps',fnorm=fnorm<br><br>#If the fit is satisfactory, divide the exposure in b'+spec_root+'_s.pi by 1./fnorm to<br># get the normlized on-source blank-sky background. This b'+spec_root+'_s.pi should then<br>#be used for the on-source background subtraction.<br>#Compared to approach 1, you may be more easily get a good fit between the <br>#two spectra since they are from the same detector region. But approach 3 <br>#does not allow for the error propagation, whereas in approach 1 the fit  uses<br>#the blank-sky data which have high counting statistics and the off-source<br>#counting statistics is properly propagated into the XSPEC.<br>;------------------------------------------------------------<br>Approach #4: <br><br>The same as Approach #3. But the statistical error in the off-source <br>spectral substraction cannot be neglected and/or the normalization fits are not <br>acceptable. you may do a joint fit of the on- and off-source spectra (with the <br>corresponding blank-sky spectra subtracted) in XSPEC. This approach in principle <br>accounts for both the background difference and error propagation accurately,<br>but is a bit more difficult to use. Now we need the arf and rmf files for the<br>off-source spectrum. <br>#-----------------------------------<br>punlearn acisspec<br>pset acisspec soufile1="${eventfile}[sky=region($reg_b)]"<br>pset acisspec root=${spec_root}_b<br>pset acisspec clobber = yes<br>pset acisspec mode=h<br>pset acisspec verbose=2<br>acisspec <br>#-----------------------------------<br>#No longer needed, the correction is now apllied automatically in acisspec, see http://cxc.harvard.edu/ciao/threads/aciscontam/index.html#new_arf<br>#apply the low energy sensitivity degradation correction to the off-source arf file:<br># mv ${spec_root}_b_sou.warf ${spec_root}_b_sou_pre_abs.warf<br># apply_acisabs ${spec_root}_b_sou_pre_abs.warf ${spec_root}_b_sou.warf<br>#-----------------------------------<br>#group the source spectrum:<br><br>#for a diffuse feature, first use the IDL sp_group to produce a group file<br>#The outputs should be used in IDL (for example)<br>spec_root='cluster'<br>;spec_root='disk'<br>bspec=spec_root+'_bgd.pi' ;for approach 1<br>;bspec='b'+spec_root+'_s.pi' ;for approach 2-4<br>sp_group,spec_root+'_sou.pi',bspec,ctonth=4,fout=spec_root+'_sou_g.grp'<br>#for approach 4, you also need<br>sp_group,spec_root+'_b_sou.pi','b'+spec_root+'_b.pi',ctonth=2,fout=spec_root+'_b_sou_g.grp'<br><br>#Then exit from the IDL, run the FTOOLS command to regroup the spectra, using<br># the abobe group file. (need to change the group file name accordingly):<br>rm ${spec_root}_sou_g.pi<br>grppha ${spec_root}_sou.pi ${spec_root}_sou_g.pi <br>group cluster_sou_g.grp<br>show group<br>exit<br>#for approach 3 or 4, further use "chkey backfile bcluster_s.pi" before exit<br><br>#for approach 4, you also need<br>rm ${spec_root}_b_sou_g.pi<br>grppha ${spec_root}_b_sou.pi ${spec_root}_b_sou_g.pi <br>group cluster_b_sou_g.grp<br>chkey backfile bcluster_b.pi<br>show group<br>exit<br><br>#=======================================================================<br>#run xspec in another window (just an example here, changing file names, <br># models etc, accordingly). <br>xspec<br>da cluster_sou_g.pi <br>ig **-0.4 8.-**<br>mo me wa <br><br>fit 20 0.05<br><br>setplot e<br>cpd /xw<br>plot<br>flux 0.5 4<br>#=======================================================================<br><br>#For the approach 4, the norm of the non-background model(s) should be<br>#set equal to 0 for the data set 2. The choice of the background is tricky, <br># depending on whether<br>#or not the access is due to particles or due to X-rays: po/b is appropriate <br># for particles; me maybe for X-rays:<br>xspec<br>da 1:1 cluster_sou_g.pi<br>da 2:2 cluster_b_sou_g.pi<br>ig **-0.4 8.-**<br>mo me wa po/b<br><br>new 3 0.03 0.001 -10 -10 10 10<br>fit<br><br>setplot e<br>cpd /xw<br>plot<br>flux 0.5 4<br><br>;======================================================================<br>Here is an example output from XSPEC for approach 4:<br> telescope = CHANDRA , instrument = ACIS , channel type = PI<br>  Current data file : cluster_sou_g.pi<br>   with integration time    8.0540E+04<br>          effective area     1.000<br>    selected region area    2.0291E-03<br>  Background file : bcluster_b.pi<br>   with integration time    5.5000E+05<br>      and effective area     1.000<br>    selected region area    5.8516E-03<br>  No current correction<br>  Response (RMF) file    : cluster_sou.wrmf<br>  Auxiliary (ARF) file    : cluster_sou.warf<br> Weighting method is standard<br>  Noticed channels     4 to   161<br>  File observed count rate    6.1038E-02+/-1.01185E-03 cts/s( 75.0% total<br>  Model predicted rate :   0.5879E-01<br><br> Information for file   2<br>  belonging to plot group   2, data group   2<br> telescope = CHANDRA , instrument = ACIS , channel type = PI<br>  Current data file : cluster_b_sou_g.pi<br>   with integration time    8.0540E+04<br>          effective area     1.000<br>    selected region area    5.8516E-03<br>  Background file : bcluster_b.pi<br>   with integration time    5.5000E+05<br>      and effective area     1.000<br>    selected region area    5.8516E-03<br>  No current correction<br>  Response (RMF) file    : cluster_b_sou.wrmf<br>  Auxiliary (ARF) file    : cluster_b_sou.warf<br> Weighting method is standard<br>  Noticed channels     3 to    10<br>  File observed count rate    4.6329E-03+/-9.21273E-04 cts/s(  7.7% total<br>  Model predicted rate :   0.4895E-02<br><br>  Model:  ( ( meka[1] )wabs[2] ) + powerlaw/b[3]<br>  ---------------------------------------------------------------------------<br>  ---------------------------------------------------------------------------<br>  Model:  ( ( meka[1] )wabs[2] ) + powerlaw/b[3]<br>  Model Fit Model Component  Parameter  Unit     Value                    Data<br>  par   par comp                                                          group<br>    1    1    1   meka       kT       keV        3.157     +/-  0.2569       1<br>    2    2    1   meka       nH       cm-3       1.000     frozen            1<br>    3    3    1   meka       Abundanc           0.2993     +/-  0.8598E-01   1<br>    4    4    1   meka       Redshift           0.2500     frozen            1<br>    5    5    1   meka       norm               6.2855E-04 +/-  0.6599E-04   1<br>    6    6    2   wabs       nH       10^22     9.8793E-02 +/-  0.1309E-01   1<br>    7    8    3   powerlaw/b PhoIndex          -5.5786E-02 +/-  0.2518       1<br>    8    9    3   powerlaw/b norm               5.5622E-04 +/-  0.4764E-03   1<br>    9    1    4   meka       kT       keV        3.157     = par   1         2<br>   10    2    4   meka       nH       cm-3       1.000     = par   2         2<br>   11    3    4   meka       Abundanc           0.2993     = par   3         2<br>   12    4    4   meka       Redshift           0.2500     = par   4         2<br>   13    7    4   meka       norm                0.000     frozen            2<br>   14    6    5   wabs       nH       10^22     9.8793E-02 = par   6         2<br>   15    8    6   powerlaw/b PhoIndex          -5.5786E-02 = par   7         2<br>   16    9    6   powerlaw/b norm               5.5622E-04 = par   8         2<br>  ---------------------------------------------------------------------------<br>  ---------------------------------------------------------------------------<br> Chi-Squared =      173.5304     using   166 PHA bins.<br> Reduced chi-squared =      1.084565     for    160 degrees of freedom<br> Null hypothesis probability = 0.220<br> 1     2.75226         3.59869<br>    3    0.164922        0.453448<br>    6    7.925481E-02    0.120520<br><br><br>flux 0.5 8<br> Model flux  1.5322E-04 photons ( 3.9138E-13 ergs)cm**-2 s**-1 (  0.500-  8.000) <br> Model flux  1.9749E-04 photons ( 4.4669E-13 ergs)cm**-2 s**-1 (  0.500-  8.000) DtSet<br>#===================================================================<br></pre>
</body>
</html>
