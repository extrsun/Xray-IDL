<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="content-type">
  <title>memo_cal.html</title>
  <meta content="Daniel Wang" name="author">
</head>
<body>
<pre>#===========================================================<br># Construct an ACIS background event file, using the stowed (instrument) background data<br># (or use the blank-sky background, if you know what you are doing)<br># see http://cxc.harvard.edu/contrib/maxim/acisbg/<br># <br># written by wqd, July 13, 2004, based on the info provided by ShiKui Tang<br># updated by wqd, June 2, 2007, including the VF cleaning (but the BI chips are not CTI-corrected; 325k exposure for the stow data)<br># Eventually, this memo needs to be updated to use<tt><a
 class="helplink"
 title="Ahelp (tools): Modify aspect solution file RA, Dec, and roll or updfile WCS to minimize position differences between two source lists."
 href="http://cxc.harvard.edu/ciaobeta/ahelp/reproject_aspect.html"> reproject_aspect:</a></tt><br># But right now (June 29,2007), the CADDB stow data are still from 2004, which does not work for make_acisbg.par<br># acisbg06 is from 2006, but does not work for <tt><a
 class="helplink"
 title="Ahelp (tools): Modify aspect solution file RA, Dec, and roll or updfile WCS to minimize position differences between two source lists."
 href="http://cxc.harvard.edu/ciaobeta/ahelp/reproject_aspect.html">reproject_aspect</a></tt><br>#===========================================================<br>#in the main directory of the observation<br>mkdir back <br>cd back<br>setenv MAINDIR ..<br>set evtroot='evt2file_new_clean'<br>set bevtroot=${evtroot}_b<br>#assumed in the default make_acisbg.par<br><br>#auto find the the aoff file <br>ln -s  $MAINDIR/cal/${evtroot}.fits ${evtroot}.fits<br>find $MAINDIR -name 'acis*_aoff1.fits.gz' -exec gunzip {} \;<br>find $MAINDIR -name 'acis*_aoff1.fits' -exec ln -s {} aoff.fits \;<br><br>#Assuming all the background data and related files are in (make sure that they are the latest) <br>set STOWDIR='/net1/hobby/CHANDRA/acisbg06/data'                                 <br><br>#If VF flag is used for the data, then <br>rm ${bevtroot}.fits<br>fcopy ${STOWDIR}/acis_D_0123567_stowed_evt_150606.fits"[events][status==bxxxxxxxx0xxxxxxxxxxxxxxxxxxxxxxx]" ${bevtroot}.fits<br>#otherwise, cp ${STOWDIR}/acis_D_0123567_stowed_evt_150606.fits ${bevtroot}.fits<br>#for the blank-sky background, use for example ${STOWDIR}/data/acis_D_0123567_stowed_evt_150606.fits ${bevtroot}.fits<br>#No stow data for chip 8 (on the other side of the BI chip 7). <br>dmcopy "${bevtroot}.fits[ccd_id=5,6,7]" ${bevtroot}.fits clobber=yes<br>#for ACIS-I, dmcopy "${bevtroot}.fits[ccd_id=0,1,2,3]" ${bevtroot}.fits clobber=yes<br><br>dmkeypar ${evtroot}.fits GAINFILE echo+<br>dmkeypar ${bevtroot}.fits GAINFILE echo+<br><br>#If the gainfiles are different, change the gainfile to the one used for ${evtroot}.fits<br>#(ciao 3.3 or early version may have problem to have the right gainfile):<br>punlearn <a
 class="helplink"
 title="Ahelp (tools): Produce or update TIME, coordinates, PI, GRADE, and STATUS information in ACIS event files"
 href="http://cxc.harvard.edu/ciaobeta/ahelp/acis_process_events.html">acis_process_events</a><br>acis_process_events infile= ${bevtroot}.fits outfile= ${bevtroot}.fits \<br>      acaofffile=NONE stop="none" doevtgrade=no apply_cti=no apply_tgain=no \<br>      calculate_pi=yes \<br>      gainfile=$CALDB/data/chandra/acis/bcf/gain/acisD2000-01-29gain_ctiN0006.fits \<br>      eventdef="{s:ccd_id,s:node_id,i:expno,s:chip,s:tdet,f:det,f:sky,s:phas,l:pha,l:pha_ro,f:energy,l:pi,s:fltgrade,s:grade,x:status}" clobber=yes<br><br>#The following may be more appropriate for acis-I observations. But no much change is noticed.<br>punlearn <a
 class="helplink"
 title="Ahelp (tools): Produce or update TIME, coordinates, PI, GRADE, and STATUS information in ACIS event files"
 href="http://cxc.harvard.edu/ciaobeta/ahelp/acis_process_events.html">acis_process_events</a><br>acis_process_events infile= ${bevtroot}.fits outfile= ${bevtroot}.fits  badpixfile=../cal/bpixfile.fits\<br>      acaofffile=NONE stop="none" doevtgrade=no apply_cti=yes apply_tgain=yes \<br>      calculate_pi=yes \<br>      gainfile=$CALDB/data/chandra/acis/bcf/gain/acisD2000-01-29gain_ctiN0006.fits \<br>      eventdef="{s:ccd_id,s:node_id,i:expno,s:chip,s:tdet,f:det,f:sky,s:phas,l:pha,l:pha_ro,f:energy,l:pi,s:fltgrade,s:grade,x:status}" clobber=yes<br><br>chmod a+rwx ${bevtroot}.fits<br>#The above gainfile needs to be modified, according to the observing phase and instr<br><br>ln -s ${PUBDIR}/cal_scripts/make_acisbg.par ./<br><br>ln -s ../cal/${evtroot}_gti.fits ./gti.fits<br>#ln -s ../cal/_eventsfile_gti.fits ./gti.fits #changed on June 26, 2007<br><br>${PUBDIR}/cal_scripts/make_acisbg<br>;--------------------------------------------------------------------------------<br>#the above step seems to have trouble running under ciao 4.0-beta, but works fine for earlier versions:<br>#open a new window to start the ciao of an early version (check your .cshrc file for details):<br>source $NETDIR/software/ciao.csh<br>ciao<br>set evtroot='evt2file_new_clean'<br>set bevtroot=${evtroot}_b<br>${PUBDIR}/cal_scripts/make_acisbg<br>;--------------------------------------------------------------------------------<br>#end for single observation<br>;=====================================================================================================================<br>#for processing multiple observations; e.g., (assuming no VF cleaning). not recently tested!!!<br>/net1/hobby/pub/cal_scripts/bg_mob.e "2954 2953 3392 3663 1561_0 3665 1561_1 3393" /d2/gc_new/ "0,1,2,3" "/net1/hobby/data/caldb_3.0.0/data/chandra/acis/bcf/bkgrnd/" "acisiD2000-12-01bkgrnd_ctiN0001.fits"<br><br>/net1/hobby/pub/cal_scripts/bg_mob.e "2954 2953 3392 3663 1561_0 3665 1561_1 3393" /d2/gc_new/ "0,1,2,3" "/net1/hobby/data/caldb_3.0.0/data/chandra/acis/bcf/bkgrnd/" "acisiD2000-12-01bkgrnd_ctiN0001.fits"<br>;=====================================================================================================================<br>;in IDL, run the following to normalize the background using the rates in the 10-14 keV for BI chips and 10-12 keV for FI chips<br>instr='acisi' ;change accordingly!!!<br>cenvset,instr <br>;-------------------<br>;read in the event list<br>evtroot='evt2file_new_clean' ;default file name root<br>ccd=[0,1,2,3] ;for an ACIS-I observation<br>;ccd=[5,6,7] ;for an ACIS-S observation, adjust accordingly for the actual selection of the CCD chips<br>cal_background,evtroot+'.fits',evtroot+'_b.fits',ccd,bnorm=bnorm,ebnorm=ebnorm<br>;If bnorm is considerably greater than 1 (e.g., &gt;10%), record the values, which will be needed in the spectral and imaging analyses.<br><br>;generate background images with bnorm corrections:<br>fdir='./'<br>evt_image,evtroot,instr,ca,ta,ba=ba,datadir=fdir,hdr=mh,xmin=xmin,ymin=ymin,bmin=bmin,bmax=bmax,imb=block,imdim=imdim $<br> ,imccd=imccd,bfname=evtroot+'_b.fits',bimfroot=evtroot+'_b',bnorm=bnorm,/bmaponly   <br>==========================================<br><br></pre>
</body>
</html>
