<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="content-type">
  <title>memo_cal.html</title>
     
  <meta content="Daniel Wang" name="author">
</head>
<body>
<pre>##########################################################################<br># 	Memo for Chandra ACIS observation calibration<br>#<br>#  You can run the unix cammands and scripts, using copy and paste.<br>#  It helps to understand the scipts (*.e), at least the information in <br>#	the headers.<br>#<br>#  After a successful run, you can move on to read the file "memo_anal" about<br>#  post-calibration analysis (e.g., source detection and image construction).<br>#<br># Requirements:<br># 1) The environment variable PUBDIR needs to be defined (ideally in your <br>#   .cshrc); e.g., setenv PUBDIR /net/xray/pub, which is where you have <br>#    installed cal_scripts directory.<br># 2) ciaoinit.e should have been run (e.g., type<br># 	source $PUBDIR/cal_scripts/ciaoinit.e and then type ciao)<br># 3) Standard archival files have been downloaded and untared in the so-called <br># 	main directory (e.g., n4631)<br># 4) Make a directory called cal (mkdir cal) in the main directory<br>#	and move into it (cd cal)<br># 5) For cleaning high background intervals of the observation without <br>#  potential effects due to source variability, a bright source regional <br>#  file (source.reg) is then needed in the  ciao format and saved<br>#	 in the current directory (e.g., usign ds9). If the file is not <br>#	provided, no region is removed. The cleaning uses a non-ciao package<br>#	acisbg from Markavich (lc_clean), which is assumed to be installed in <br>#	$LOCALDIR<br>#<br># Key decisions need to be made (see the following):<br>#  1) processing choice:<br>#	evt1 - from evt1 to evt2 (def)<br>#	evt2: just modify evt2<br>#  3) VF mode flag: yes - to reduce the background in the timed VF mode <br>#	(good for diffuse study. However, a significant fraction of the <br>#	source events may be flagged and removed for moderately bright to <br>#	bright sources. <br>#	no - no flag, which may be good for studying discrete sources<br>#     In principle, two versions of the process may be produced for the VF mode<br>#<br># written by wqd, July, 2002<br># updated by wqd, Jan 5, 2003: 1) several shell variables are converted <br># 	into environment valiables to simplify the entries to scripts<br>#	2) multiple file processing scripts are added.<br>##########################################################################<br>#To turn on the creation of count and flux maps by make_expmap.e, <br># setenv CMAP 1<br>setenv CMAP 0<br><br>#as Sept, 2003, CTI corrections can be applied only to the ACIS-I array <br># and/or chip S2 and are available for -120 C observations <br>#setenv APPLYCTI yes<br>setenv APPLYCTI no<br><br>#set the default root name for processed files:<br>set event_root=evt2file<br><br>#making the right choice of the instrument:<br>setenv INSTR aciss<br>#setenv INSTR acisi<br>#special for the GC observations and others with high absorption:<br>#setenv INSTR acisi_low<br>#-----------------------------------------------------<br>#From the main dir, check to see if there are multiple OBIs:<br>ls ./*/acis*evt1.fits*<br><br>#The processing needs to be done separately for each OBI, see<br># http://cxc.harvard.edu/ciao/dictionary/obi.html<br>#If there more than 1 entries, the following links are problematic; the OBI<br>#needs to be consistent, e.g., the observing time should match the right asol <br>#file. It is advised to processed them in different directories (e.g., <br>#1561_0 and 1561_1); for example.<br>ln -s ../../1561/primary/acisf01561_001N001_bpix1.fits  acisf01561_001N001_bpix1.fits<br>ln -s ../../1561/primary/acisf01561N003_evt2.fits acisf01561N003_evt2.fits<br>ln -s ../../1561/primary/pcadf111463469N001_asol1.fits pcadf111463469N001_asol1.fits<br><br>ln -s ../../1561/secondary/acisf01561_001N001_evt1.fits acisf01561_001N001_evt1.fits<br>ln -s ../../1561/secondary/acisf01561_001N001_flt1.fits acisf01561_001N001_flt1.fits<br><br><br>#-----------------------------------------------------<br>#move to the processing directory<br>cd cal<br>#main directory (containing primary etc) relative to this processing direction<br>setenv MAINDIR ..<br><br>#uppack the necessary files:<br>find $MAINDIR -name 'acis*bpix1.fits.gz' -exec gunzip {} \;<br>find $MAINDIR -name 'pcadf*_asol1.fits.gz' -exec gunzip {} \;<br>find $MAINDIR -name 'acis*evt2.fits.gz' -exec gunzip {} \;<br><br>#make soft links to default file names:<br>find $MAINDIR -name 'acis*bpix1.fits' -exec ln -s {} bpixfile.fits \;<br>rm asol_file<br>find $MAINDIR -name 'pcadf*_asol1.fits' -exec sh -c 'ls {} &gt;&gt; asol_file' \;<br>find $MAINDIR -name 'acis*evt2.fits' -exec ln -s {} ${event_root}.fits \;<br><br>#check that the links are correct:<br>ls -ltr bpixfile.fits ${event_root}.fits<br>more asol_file<br>#--------------------------------------------------------------------<br>#for archival data, normally you need to reprocess the evt2 data<br>#see http://cxc.harvard.edu/ciao/threads/cti_choices/<br>#If evt1-to-evt2 processing is indeed required:<br>find $MAINDIR -name '*flt*.fits.gz' -exec gunzip {} \;<br>find $MAINDIR -name 'acis*flt*' -exec ln -s {} fltfile.fits \;<br><br>#for cti-corrected file (no longer needed; Dec. 12, 2002):<br>#ln -s acisf02207_000N002_evt1.no_cti.fits evt1file.fits<br>#if in the current directory or<br>#find $MAINDIR -name '*evt1.no_cti.fits' -exec ln -s {} evt1file.fits \;<br>#otherwise, use the downloaded evt1 file:<br><br>find $MAINDIR -name '*evt1*.fits.gz' -exec gunzip {} \;<br>find $MAINDIR -name '*evt1*' -exec ln -s {} evt1file.fits \;<br><br>#check that the files are actually there and are correct:<br>ls -ltr fltfile.fits evt1file.fits<br>ln -s evt1file.fits aspcorr_evt2.fits<br>#--------------------------------------------------------------------<br>#if instead, no evt1-to-evt2 processing is required:<br>#ln -s ${event_root}.fits aspcorr_evt2.fits<br>#--------------------------------------------------------------------<br>#check to see if the observation was taken in timed vfaint mode<br>dmkeypar aspcorr_evt2.fits DATAMODE ; pget dmkeypar value<br>dmkeypar aspcorr_evt2.fits READMODE ; pget dmkeypar value<br>#if it was, you MAY want to use CHVF=yes (but you need to know what this means)<br>setenv CHVF yes<br>#setenv CHVF no<br>#-----------------------------------<br>#correct for astrometry offsets:<br>proc='evt1'<br>$PUBDIR/cal_scripts/pre_cal.e $proc<br>chmod +w aspcorr_evt2.fits<br>echo "Copy the output into the website: http://asc.harvard.edu/cal/ASPECT/fix_offset/fix_offset.cgi <br>and follow the execution of the instructions on the website."<br>echo "After that you are ready for evt1to2.e or post_evt2.e."<br>dmlist aspcorr_evt2.fits header,raw,clean | egrep 'TCTYP|TCRVL|ASCDSVER|DATE|OBS_ID'<br><br>#wait for the end of the above and finish the web task and then do the next:<br>#-----------------------------------<br>#The section is only for cti correction of FI chips:<br>#if APPLYCTI=yes, we could only include ccd=0:3,6 at this point, so you may <br>#need to do the following:<br>#mv aspcorr_evt2.fits aspcorr_evt2_allccd.fits<br>#dmcopy "aspcorr_evt2_allccd.fits[ccd_id=0:3,6]" aspcorr_evt2.fits<br>#dmcopy "aspcorr_evt2_allccd.fits[ccd_id=6:8]" aspcorr_evt2.fits<br><br>#if processing from evt1 to evt2:<br>$PUBDIR/cal_scripts/evt1to2.e ${event_root}<br><br>#Check the size of the files:<br>ls -ltr ${event_root}_new.fits<br><br>#if no evt1 to evt2 processing: mv aspcorr_evt2.fits ${event_root}_new.fits<br><br>#define the energy band:<br>$PUBDIR/cal_scripts/def_bands.e<br><br>#place the output from the above into the following:<br>#setenv BANDS "500:1000 1000:2000 2000:4000 4000:8000"<br>setenv BANDS "300:700 700:1500 1500:3000 3000:7000"<br>#setenv BANDS "1000:2500 2500:4000 4000:6000 6000:9000"<br><br>#post evt2 processing:<br>#remove bright variable sources by placing them in a regional file source.reg<br>#currently only accept circle and ellipse regions.<br><br>$PUBDIR/cal_scripts/post_evt2.e ${event_root}_new <br>#drawback: the gti is read from the first gti extension and may not be the same for all chips<br>#check the lightcurve <br>fv _eventsfile.lc<br>set event_root=evt2file_new_clean<br>#======================================================================<br>#No longer needed for data processed with ciao 3.1 or later<br># Correction for the ACIS gain change with time<br># A revised version of what is compiled by Yang Chen,<br># following http://cxc.harvard.edu/contrib/alexey/tgain/tgain.html<br># June 17, 2003<br>cp ${event_root}.fits ${event_root}_pregain.fits<br><br>set gainfiledir=$NETDIR/software/corr_tgain<br><br># pget dmkeypar value<br> dmkeypar ${event_root}.fits DATE-OBS ; pget dmkeypar value<br><br>ls ${gainfiledir} <br>#to find and match the file with the closest date; e.g., (change the<br># following accordingly!!!)<br> ln -s ${gainfiledir}/corrgain2002-05-01.fits ./corrgain_data.fits<br> ${gainfiledir}/corr_tgain ${event_root}.fits -tgain corrgain_data.fits<br><br> #Recompute the photon energies and PI values:<br>set gainfile=$NETDIR/usr/local/ciao_2.3/data/chandra/acis/bcf/gain/acisD2000-01-29gainN0003.fits<br> punlearn acis_process_events<br> pset acis_process_events infile=${event_root}.fits<br> pset acis_process_events outfile=temp.fits<br> pset acis_process_events acaofffile=none<br> pset acis_process_events stop=none<br> pset acis_process_events gainfile=$gainfile<br> pset acis_process_events gradefile=CALDB<br> pset acis_process_events apply_cti=yes<br> pset acis_process_events apply_tgain=yes<br> pset acis_process_events doevtgrade=no<br> pset acis_process_events calculate_pi=yes<br> pset acis_process_events check_vf_pha=no<br> pset acis_process_events clobber=yes<br> acis_process_events<br>mv temp.fits ${event_root}.fits<br><br>#Finished. Now ${event_root}.fits has been corrected for the gain change<br>#============================================================================<br>#If bands are not defined:<br>$PUBDIR/cal_scripts/def_bands.e<br>#place the output from the above into the following:<br>#setenv BANDS "500:1000 1000:2000 2000:4000 4000:8000"<br>setenv BANDS "300:700 700:1500 1500:3000 3000:7000"<br>#setenv BANDS "1000:2500 2500:4000 4000:6000 6000:9000"<br>#$PUBDIR/cal_scripts/cal_main.e $event_root $proc &gt; cal_main.log &amp;<br><br>set event_root=evt2file_new_clean<br>$PUBDIR/cal_scripts/make_expmap.e ${event_root} asol_file &amp;<br>rm _* temp_* new_*<br><br>#----------------------------------<br>#move to the main directory<br>mkdir xdata<br>cd xdata<br>#for single file, use<br> $PUBDIR/cal_scripts/cal_mob_link.e ../ "./"<br><br>#for multiple observations of a single targe<br>$PUBDIR/cal_scripts/cal_mob_link.e /d4/m82 "1302" evt2file <br><br>;for a subarray observation with only (ccd7 turned on), instead do:<br>ln -s ${evtdir}${evtfname}.fits   ${evtfname}.fits<br>ln -s ${evtdir}${evtfname}_i300:700_ccd7.fits   ${evtfname}_i1.fits<br>ln -s ${evtdir}${evtfname}_i700:1500_ccd7.fits  ${evtfname}_i2.fits<br>ln -s ${evtdir}${evtfname}_i1500:3000_ccd7.fits ${evtfname}_i3.fits<br>ln -s ${evtdir}${evtfname}_i3000:7000_ccd7.fits ${evtfname}_i4.fits<br><br># end of the data calibration!!<br><br>#If another version of the processing with slight modification is needed<br># (e.g., with CHVF=yes), you may proceed with the astrometry corrected <br># aspcorr_evt2.fits.<br><br>#check the image if there is any bright source that may produce a CCD streak.<br>#If yes, proceed to remove the streak by reading memo_dstreak.<br>##########################################################################<br># Procedure for processing multiple observations:<br># first work to the step of correcting the astrometry and <br># then do something SIMILAR to the following:<br>set oblist="1302 361 378 379 380_1 380_2"<br>$PUBDIR/cal_scripts/cal_mob.e "$oblist" &gt; cal_mob.log <br><br>./def_bands.e<br>#place the output from the above into the following:<br>setenv BANDS "500:1000 1000:2000 2000:4000 4000:8000"<br><br>$PUBDIR/cal_scripts/cal_mob_link.e "../" "${oblist}"  "evt2file_new_clean"<br>#which produce links (similar to the above) to the default file names in<br>#the directory xdata.<br>##########################################################################<br># Description of the above procedure<br>#<br>##Procedure:<br>#1) Compare the processing date and version of the data with the present CALDB<br># to see whether reprocessing evt2 is needed.<br>#<br>#2) Pre-calibration<br># 	Decompress files<br>#	Check the website for the aspect correction<br>#<br>#3) Calibration<br>#	optional evt1to2 processing (proc not= evt2)<br>#	post-evt2 processing: remove extra destreak, <br>#		bad pixels, background flares<br>#<br>#4) Make exposure maps<br>#<br>#5) Make links for subsequent data analysis (e.g., source detection and <br># smoothed 3-color flux image construction)<br>#<br>#*Outputs:<br># ${event_root}_new.fits - offset-corrected evt2 file<br># ${event_root}_new_clean.fits - cleaned evt2 file<br># various count, exposure, and flux maps<br># average light curves of the observation<br>#====================================================<br># Here is a little more detailed consideration about <br>#	whether to reprocess the evt1 data:<br> # RULE OVER THE THUMB:<br> # If you work on NEW data, no re-processing is needed unless<br> # there was a new release of the CALDB between the processing<br> # and the time you start analysing the data or you need to take advantage<br> # of the low background of the VF mode or CTI correction.<br> # If you work on OLDER data, you need to process from the evt1 data<br> # check the following:<br> #      http://cxc.harvard.edu/caldb/version_release_notes.html<br> # gives the history of the CALDB.<br>#====================================================<br># It is very important to check your results to see if the processing is OK:<br>#<br># Check the log file of the processing to see if there is any serious errors,<br># some of which can be neglected, and to check the sizes, for example.<br># Also use fv and/or ds9 to check the fits files:<br># For obsid 2025, the number of counts are exactly the same for the processed<br># and the original evt2 files. But the size of the processed one is about 1/4<br># greater, because of an extra column (array of pulse heights).<br># For CTI-corrected file, the total number of the reprocessed evt2 file <br># contains slightly less number of counts (198513 vs 198795 for a2125 obs). <br>#====================================================<br>#====================================================<br></pre>
<br>
</body>
</html>
