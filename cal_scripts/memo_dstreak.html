<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="content-type">
  <title>memo_cal.html</title>
  <meta content="Daniel Wang" name="author">
</head>
<body>
<pre>IDL procedure on calculating the ccd streak contributions for the XMM-Newton EPIC images<br><br>;In a directory dstreak under, say, pn, read in the event list:<br>instr='epic' ;need to change accordingly!!!<br>cenvset,instr<br><br>;see if the required files are available<br>evtroot='pn'<br>;evtroot='evt2file_new_clean'<br>emin=200 &amp; emax=7500<br>maindir='../'<br>fname=maindir+'xdata/'+evtroot+'.fits'<br>file_params,fname,dhdr,cra,cdec,expt,fra,fdec,xoff,yoff,roll,hdr=hdr<br><br>;imdim=512 &amp; imblock=80 <br>evt_image,evtroot,instr,ca,ta,datadir=maindir+'xdata/',hdr=hdr,xmin=xmin,ymin=ymin,list=listo,gradec=gradec,imdim=imdim,imblock=imblock,/nofits <br>window,1,xs=imdim(0),ys=imdim(1)<br>-------------------------------------------------------------------<br>;determine which bands need to be destreaked (change emin and emax accordingly):<br>tv,bscale(ca(*,*,1),0,2)<br>;-------------------------------------------------------------------<br>;produce a mask for the exposed region:<br>;tim=ta(*,*,1)<br>;expfname=maindir+'xdata/'+evtroot+'_i2.fits' ;arbitray choice<br>;-------------------------------------------------------------------<br>;source list:<br>;read_reg_str,'../pn.ee_1.5keV.reg',slist,factor=1./0.05 ;temporary solution<br> sou_fits_info,maindir+'sou/'+evtroot+'_map70BSH_hr',slist,/all<br>;slist.sradius= slist.sradius*!size_pixel ;which do not account for cntr<br>perclimit=0.7 ;for xmm, using the fraction of remaining source energy<br>;===================================================================<br>;finding the right chip (this section is needed for different bands):<br>emin=500 &amp; emax=4500<br>;emin=500 &amp; emax=8000<br>s=where(listo.ccd_id eq 4)<br>;s=where(listo.ccd_id eq 7) ;aciss<br>list_image,listo(s),xmin,ymin,im,imdim(0),imdim(1),block=imblock,emin=emin,emax=emax<br>tv,bscale(im,0,5) ;just for testing<br>list=listo(s)<br>s=where(list.energy gt emin and list.energy le emax)<br>ls=list(s)<br>im=ca(*,*,1)<br><br>blo=1 &amp; bhi=3<br>im=total(ca(*,*,blo:bhi),3) ;for example<br>;----------------------------------------<br>;dimx=64*80L<br>;dimy=200*80L<br>block=20<br>;window,xsize=dimx/block,ysize=dimy/block<br><br>outfname='test.fits' ;output file name<br>;===================================================================<br>;now following the XMM part in memo_destreak<br>loadct_self,18<br>g3=psf_gaussian(fwhm=6,/norm,npix=121) ;smoothing kernal for test plots<br>;bnorm=1.      ;normalizing the auto-determined streak flux<br>fcton=7       ;signal-to-noise ratio for the adaptive flux calculation<br>stonth=2.5     ;# of sigma above which to consider the streak contribution<br>nofile=0 ;set 1 for no output fits file<br>xrange=0   ; select only the pixels with column-mean fluxes &gt; stonth defined<br>        ;in streak_removeal_main<br>;xrange=[2610    ,3329] ;streak is in a predefined range<br><br>;region for calculating the flux distribution<br>;x1=0 &amp; x2=dimx/block-1 &amp; y1=0 &amp; y2=dimy/block-1<br><br>;run the main program which outputs the background fits file<br>newpexcl=-1    ;&gt; 0 for getting exclusion region, &lt; 0 for getting inclusion region<br>        ;if abs(newpexcl)=1, new selection. newpexcl not = 1 or -1  will be set by         ;need to change accordingly!!!<br>;nofile=1 ;if =1, no file output; if = 0, file output<br>;!debug=1<br> .run streak_removal_main<br><br>;additional regions may be excluded by selecting an individual region, using<br>; !debug=1, which places the index in sexcl.<br>;===================================================================<br>;just for testing:<br>;tv,bscale(cs,0,2)<br>tv,bscale(ccdbim)<br>a=convolve(rfim,g3)<br>tv,bscale(a,0,30) ;in units of counts per arcmin^2<br>wset,1<br>tv,bscale(convolve(fim,g3),0,30)<br><br>flux=flux*1.e10<br>eflux=eflux*1.e10<br>mflux=mflux*1.e10<br>sh_plot,dis,flux,eflux,dis*0.+mflux,xrang=[0,dimx],xtit='Column number',ytit='Counts pixel!U-1!N 10!U10!Ns!U-1!N',psym=1<br>oplot,dis(ss),flux(ss),psym=2 ;selected bins<br>device,/close<br>$gv idl.ps<br>;-----------------------------<br>;find the xrange the includes the whole streak, e.g.,<br>print,ss<br>print,dl(31),dh(41)<br>;use the output for xrange and rerun  streak_removal_main<br>;===================================================================<br>;normalization factors for calculating the streak contribution in<br>; various bands:<br> <br>558 ;0.5-2 keV<br>789 ;0.5-4.5 keV<br></pre>
</body>
</html>
