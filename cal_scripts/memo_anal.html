<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="content-type">
  <title>memo_cal.html</title>
  <meta content="Daniel Wang" name="author">
</head>
<body>
<pre>##########################################################################<br># 	Memo for Post-calibration analysis of X-ray CCD imaging data<br>#<br>#Specific analyses:<br>#	1) source detection <br>#	2) 3-color image construction<br>#	3) overlay of X-ray contours on optical image<br>#<br>#  You can run the IDL cammands, using copy and paste.<br>#  It helps to understand the key procedures, at least the headers<br>#	(e.g., using doc_library,'procedure name').<br>#<br>#<br># Requirements:<br># 1) wqd's idl software (xrayidl) has been installed<br># 2) You may need to setup the IDL appropriately, by including the following <br>#    in your .cshrc file<br>#    	setenv xidl $PUBDIR/xrayidl<br>#   	setenv IDL_DIR /usr/local/rsi/idl<br>#   	alias xidl 'source $xidl/xidl_setup<br>#    IDL can then be run by typing "xidl"<br>The environment variable PUBDIR needs to be defined (ideally in your <br>#   .cshrc); e.g., setenv PUBDIR /net/xray/pub, which is where you have <br>#    installed cal_scripts directory.<br>#<br># Key parameters need to be defined (see the following):<br>#  1) instrument choice (i.e., aciss, acisi, acisi_low; def = aciss)<br>#<br># You really need to know a bit about IDL to be productive. Also it is useful<br># to copy the commands you are actually using.<br>#<br># written by wqd, July, 2002<br># updated to accormodate EPIC data, wqd, April 1, 2005<br>##########################################################################<br>;Source detection:<br>;first produce a directory called sou in the main directory <br>;	(i.e., /d1/n3556/sou) and<br>cd sou<br>; Now in IDL (by typing xidl)<br>;<br>;copy and paste to run the following:<br>instr='aciss' 			;change to the appropriate instrument<br>;instr='acisi'<br>;instr='epic'<br><br>;the following the default:<br>loadct_self,18<br>evtfname='evt2file_new_clean' <br>;evtfname='pn'<br>;---------------------------------<br>;options for inputs and outputs<br>;evtfdir='../xdata/'<br>;mapdir='../xdata/'<br>;window,xs=1024,ys=1024<br>;greymin=3<br>;greymax=100<br>;nband=4<br>;noplot=0<br>;plotout=1<br>;---------------------------------<br>;options for a large FoV:<br>;edim=2048<br>;ewbin=1./2^(findgen(4)) ;if large offaxis regions (&gt; 10') is included<br>;cdim=512 &amp; cblock=2 ;or cdim=512 &amp; cblock=1 ;for a small FoV to reduce central high-res region<br>;cblock=0 ;or even no separate detection in the central region<br>;---------------------------------<br>;options to fine-tuning the detection<br>;probth=-7 ;(def=-6) if too many detetions<br>;fdfac =2 ;final source merger factor (def=1.5), if see some detections should be merged <br>;slow=2.5 ;def=2. which may be too small for a deep obs of a crowded field <br>;fac_ssr=2 &amp; cblock=0 ;fraction to be enlarged in source search<br>;fac_ssr=0.5 &amp; cdsfrac=0.5 ;for sources that are very close-by<br>;esubfac=2. ;source removal radius factor (def=1.5)<br>---------------------------------<br>;options for output energy bands, depending on absorption<br>;dhrch=2 ;for HR2=(H2-H1)/H, HR=(H1-S)/(H1+S); =1 for outputs with all three HRs (def=0 for two HR outputs: HR1=(S2-S1)/S, HR=(H-S2)/(H+S2))<br>;---------------------------------<br>;options for multi-file detections<br>;mfile=1 ; flist should be given<br>;flist='../xdata/flist.dat'<br>;---------------------------------<br>;options to save time:<br>;wavesd=0 ;no wavelet source detection and needs to supply soufile <br>;oldbmap=1 ;if =1 using old backg maps; should be reset if new bgd maps need<br>		;to be reproduced<br>;no_smina=0 ;(def=1, no sensitivity map will be calcuated to save time)<br>;------------------------<br>;for subarray with maps of block=1<br>subarray=1<br>mblock=1 ;change the deflaut block, needed for subarray images with small block exp map<br>cblock=0 <br>;------------------------<br>;for EPIC data only<br>probth=-5<br>cblock=0  ;no central separate detection <br>slow=2.5 ;threshold for initial wavelet detection (def =2)<br>;dfac=2 ;def=2<br>sradius_min=4. ;arcsec, minimum source radius for merging; def=1<br>;------------------------<br>;for destreak only (assuming the destreak image already produced)<br>sbyes=1<br>sb=fltarr(512,512,4) ;assuming the standard dim=512, block=80<br>nband=4<br>fname='../pn/dstreak/'+evtfname+'_s23.fits' ;change the band?<br>ds=readfits(fname)<br>sb(*,*,1)=ds*80^2*(223./841) ;normalized by the band ratio, change?<br>sb(*,*,2)=ds*80^2*(597.5/841) <br>;--------------------------<br>;multiple bands:<br>;sband=['B','S','H'] ;def<br><br>.run sou_main<br>;--------------------------<br>; for aciss, using the following spectral parameters for HR model plotting:<br>mnv=[1.,10,20,40,100,300] ;column density in units of 10^20 cm^-2<br>mrv=[0.2,1,1.5,2] ;thermal model with kt in keV<br><br>;mcdim=256 ;final central plot dim; def=512<br>;imcoff=[-80,150] ;pixel offset of the central plot, def=[0,0]<br><br>;apsyserr=? ;arcsec, for additional position error beyond 0.2+1.4*(oa/8.)^2<br>;radec_off=val(0:1) ;after astrometry correction<br>;--------------------------<br>.run sou_final<br>;-----------------------------<br>;you might want to redefine the axis ranges of HR plots, e.g.,<br>;for acis-s<br>h1xr=[-1,0.5] &amp; h1yr=[-0.1,1.]<br>h2xr=[-1,1] &amp; h2yr=[-1,0.2]<br>h2yr=[-1,0.5]  ;for PN<br><br>.run sou_final<br>;-----------------------------<br>;If you know what you are doing, proceed!<br>;remove detections that are certainly artifacts (CCD streak, PSF, etc)<br>;or $gv pn_map70BSH_cm.ps &amp; <br>;or ncmb=readfits(soufile+'_cm.fits',hh)<br>cont_grey,ncmb,hh,/noc,cor=cor,greymin=greymin,greymax=greymax $<br>		,greyl=2,/full,/def,barf=0,f_c=-1,/ps<br>plot_reg,cor,hh,soufile+'_hr.reg',crval=crval ;,factor=subfac<br>;soufile='pn_map70BSH'<br>sou_fits_info,soufile,slist,/all,probth=probth<br>source_plot,'',cor,hh,psym=6.,sym=0.5 $<br> ,/sou_no,sra=slist.ra,sdec=slist.dec,sn=slist.sn $<br> ,s_c=!d.n_colors-1,nssh=slist.sn,xsh=(!size_pixel*1.3)*slist.sradius $<br> ,ysh=(!size_pixel*1.3)*slist.sradius<br><br>;use ds9 to check the source regions and their regitimacy, remove fake<br>;detections (diffuse emission peak, streak, edge, etc) and save the<br>;the revised reg file to test.reg<br>oregfile='evt2file_new_clean_map70BSH_hr.reg'<br>nregfile='test.reg'<br>reg_match,oregfile,nregfile,sel=sel,rsel=sexcl<br><br>;or directly examine the ps plots to find the source numbers:<br>;sexcl=[plotted source numbers]<br><br>;if no longer need sexcl, need delvar,sexcl<br>.run sou_final<br>;=============================================================================<br>;some useful plotting commands used in sou_main and sou_final:<br>cont_grey,cm,hh,/noc,cor=cor,greymin=greymin,greymax=greymax,greyl=2,/full,/def,barf=0,f_c=-1,/ps<br>source_plot,soufile,cor,hh,slow=0,probth=probth,psym=6.,sym=2,/fits,s_c=!d.n_colors-1<br>;=============================================================================<br>; now source analysis is finished!<br>; Here are some additional tools for producing useful plots (for examples):<br>; 1) count map in an individual band<br>list_image,l,xmin,ymin,c,dim,block=block,emin=bmin(0),emax=bmax(3),sel=sel<br>; 2) resizing and smoothing<br>hdim=[512,270]<br>cc=convolve(image_cut(c,hdim,/pix,/rec),g2)<br>get_fitshead,cc,hsh,hh<br>;device,bits=8,/land,color=1,xsize=hdim(0)*18/hdim(1),ysiz=18,yoff=22,xoff=4<br>cont_grey,cc,hsh,/noc,cor=cor,greymin=0.1,greymax=4,greyl=2,/full,/def,barf=0,f_c=-1,/ps<br>source_plot,soufile,cor,hsh,slow=0,probth=probth,psym=6.,sym=2 ,/fits,s_c=!d.n_colors-1<br>source_plot,soufile,cor,hsh,slow=0,probth=probth,psym=6.,sym=cs,/fits,/sou_no,sn=slist.sn,s_c=!d.n_colors-1,nssh=[36,41],xsh=[0,-30],ysh=[4,0]<br><br>window,xs=dim,ys=dim<br>tv,bscale(tb)<br>s=defroi(1024,1024) ;selection the ccd7 region<br>sou_rsel,hh,a,inf=soufile,outf=soufile+'_ccd7',rpsel=s,image=tb,s_c=0<br>.run sou_final<br><br>;=====================================================================<br><br>Check NED for galaxy parameters (http://nedwww.ipac.caltech.edu/forms/byname.html)<br>Record the relevant information:<br><br>Galaxy Name	R.A.		Dec.	Type		Diameters	Mag  	E(B-V)<br>NGC 2403  	07h36m51.4s +65d36m09s SAB(s)cd		21.9 x  12.3	8.93 	0.040<br>		114.214167   65.602583<br><br>NGC 3877	176.531595   47.494781 Sc		5.5 x   1.3	11.79	0.023 <br>NGC 3556	11h11m31.20s  +55d40m25.0s<br>		167.880000   55.673611 <br>;===================<br>; download optical images from<br>; http://skyview.gsfc.nasa.gov/cgi-bin/skvadvanced.pl<br>; use the above obtained RA and Dec in degrees (add a sign if +; e.g., 167.880000, +55.673611)<br>;select DSS2 Red and Blue<br>size (pixel): 512<br>size(degree)<br>     0.139662 (for acis-s; 0.492*512/3600.*2)<br>     0.209920 (for acis-i; 0.492*512/3600.*3)<br>;save the fits files into dss2_red.fits and dss2_blue.fits in the directory ../mdata (needs to be created if not exits)<br>;===================================================================<br>;Now in IDL, extract the images of the galaxy in multiple bands:<br>;move the anal directory:<br>$mkdir ../anal<br>cd,'../anal<br>evtroot='evt2file_new_clean' <br>instr='aciss'<br>cenvset,instr<br>evtroot='evt2file_new_clean' <br>gradec=[189.9976254,-11.6230511] ;change accordingly<br>imdim=512  &amp; imblock=2 &amp; ccdid=[6,7,8] ;for aciss<br>;imdim=1024 &amp; imblock=1 &amp; ccdid=[6,7,8] ;for aciss<br>;bfname='../back/bevt2file_new_clean_ccd'+strtrim(ccdid,2)+'.fits' ;for aciss<br>;bfname='../back/bevt2file_new_clean.fits' ;for acissi<br>evt_image,evtroot,instr,datadir='../xdata/',hdr=mh,xmin=xmin,ymin=ymin,list=l,c,imdim=imdim,imblock=imblock,gradec=gradec ;,bfname=bfname,expt=expt ;for image background subtraction (see below)<br>;=============================================================<br>;==============================================================<br>;if background subtraction is needed; multiple files are allowed.<br>;if the above inclusion failed, consider to do the following:<br>datadir='../../back/'<br>bfroot='bevt2file_new_clean'<br>print,sxpar(headfits(datadir+bfroot+'.fits',ext=1),'livetime')<br>;check the output with that expected from<br>; http://cxc.harvard.edu/contrib/maxim/acisbg/data/README<br>;<br>bexpt=380000. ;change this to the correct value <br>evt_image,'bevt2file_new_6_clean',instr,datadir=datadir,/noexp,/nofits,xmin=xmin,ymin=ymin,c,imdim=imdim ;,gradec=<br>for k=0,3 do cc(*,*,k)=cc(*,*,k)+c(*,*,k)*expt/bexpt<br>for k=0,3 do writefits,'b_'+strtrim(k+1,2)+'.fits',cc(*,*,k),mh<br>;=============================================================<br>;==============================================================<br>Now run the script under ciao in the same directory:<br>$PUBDIR/cal_scripts/mcsmooth.e &amp;<br>;default s/n=3-4 with no background image smoothing<br>;or $PUBDIR/cal_scripts/mcsmooth.e "1 2 3 4" 2.5 3.5 b &amp;<br>;using s/n=2.5-3.5 with background image smoothing<br>;=============================================================<br>;==============================================================<br>;back in IDL:<br>;target='n3556'		;change to the appropriate name<br>soufile='../sou/evt2file_new_clean_map70BSH_hr'<br>probth=-7<br>edge=6<br>filter=readfits('t_4.fits') ;to remove regions outside the exposure map<br>read_mimages,4,mh,fs,a,mv,cor=cor,edge=edge,mdim=mdim,filter=filter<br>;=============================================================<br>;==============================================================<br>; only used for rescaling and adjusting the colors<br>;for 1+2,3, 4 bands<br>a(*,*,0)=bscale(alog10(fs(*,*,0)+fs(*,*,1)),alog10(mv(0)+mv(1)),alog10((mv(0)+mv(1))*10))<br>a(*,*,1)=bscale(alog10(fs(*,*,2)),alog10(mv(2)),alog10(mv(2)*10))<br>a(*,*,2)=bscale(alog10(fs(*,*,3)),alog10(mv(3)),alog10(mv(3)*10))<br>cont_grey,a,mh,cor=cor,true=3,mr=0,/ps,/nocon,/full,f_c=-1,barf=0.<br><br>;for 1,2,3+4 bands<br>a(*,*,0)=bscale(alog10(fs(*,*,0)),alog10(mv(0)),alog10(mv(0)*10))<br>a(*,*,1)=bscale(alog10(fs(*,*,1)),alog10(mv(1)),alog10(mv(1)*10))<br>a(*,*,2)=bscale(alog10((fs(*,*,2)+fs(*,*,3))),alog10(mv(2)+mv(3)),alog10((mv(2)+mv(3))*10))<br>;-----------------<br>;You can use the following for a look of individual channel (e.g.,):<br>k=1<br>tv,bscale(alog10(fs(*,*,k)),alog10(mv(k)),alog10(mv(k)*10)),chan=k+1<br>;-------------------------------<br>;output jpeg images:<br>s=tvrd(0,0,true=3) &amp; write_jpeg,target+'_rgb.jpg',s,true=3<br>;or ps file:<br>set_plot,'ps'<br>device,bits=8,/land,color=1,xsize=18.,ysiz=18,yoff=26,xoff=2<br>loadct,0 ;for the 3-color image<br>;-------------------------------<br>window,1,xs=mdim(0),ys=mdim(1)<br>cont_grey,a,mh,cor=cor,true=3,mr=0,/ps,/nocon,/full,f_c=-1,barf=0.<br>scale='1''<br>scale_plot,cor,mh,0.08,0.93,1,scale,thick=2,char=2,color=!d.n_colors-1<br>source_plot,soufile,cor,mh,/fits,probth=probth,psym=6,sym=2<br>source_plot,soufile,cor,mh,/fits,probth=probth,psym=6,sym=1,/sou<br><br>s=tvrd(0,0,true=3) &amp; write_jpeg,target+'_rgb_s.jpg',s,true=3<br>;-----------------<br>;get a broad band X-ray image:<br>loadct_self,18<br>f=total(fs,3)<br>cont_grey,f,mh,cor=cor,/ps,barf=0.,/def,/noc,greymin=total(mv),greymax=30,greylo=1<br>;-------------------------------------<br>;comparison with optical image:<br>o=image_cut(readfits('../mdata/dss2_blue.fits'),mdim(0)/2,/rec,/pix)<br>o=o-min(o)*0.99<br>lev=[0.5,1,2,4,7,11,16,22,29,37]*0.2+total(mv)<br>cont_grey,f,mh,o,cor=cor,/ps,barf=0.,/def,lev=lev,greymin=median(o),mr=0<br>s=tvrd(0,0,true=3) &amp; write_jpeg,target+'_f_b.jpg',s,true=3<br>;======================================================<br>;for optical,1+2,3+4 bands<br>cor=[0,1,0,1]<br>;a(*,*,0)=bscale(alog10(o),alog10(median(o)),alog10(max(o)))<br>a(*,*,0)=bscale(o,median(o),max(o))<br>a(*,*,1)=bscale(alog10(fs(*,*,0)+fs(*,*,1)),alog10((mv(0)+mv(1))),alog10((mv(0)+mv(1))*10))<br>a(*,*,2)=bscale(alog10(fs(*,*,2)+fs(*,*,3)),alog10(mv(2)+mv(3)),alog10((mv(2)+mv(3))*10))<br>cont_grey,a,mh,cor=cor,true=3,mr=0,/ps,/nocon,/full,f_c=-1,barf=0.<br>scale='1''<br>scale_plot,cor,mh,0.08,0.93,1,scale,thick=2,char=2,color=!d.n_colors-1<br>s=tvrd(0,0,true=3) &amp; write_jpeg,target+'_rgb_osh.jpg',s,true=3<br>;======================================================<br>; Radio image:<br>cast,'../mdata/N3556C20NW.FITS',mh,outa=r<br>cont_grey,r,mh,a,cor=cor,true=3,mr=0,/ps,/full,f_c=-1,barf=0.,lev=[0.5,1,2,3,4,6,10,15,30,50,100,200]*0.0002,c_c=255<br>cor=[0,1,0,1]<br>a(*,*,0)=bscale(alog10(r &gt; 1.e-5),alog10(1.e-4),alog10(max(r)))<br>a(*,*,1)=bscale(alog10(o),alog10(median(o)),alog10(max(o)))<br>a(*,*,2)=bscale(alog10(fs(*,*,0)+fs(*,*,1)),alog10((mv(0)+mv(1))),alog10((mv(0)+mv(1))*5))<br>cont_grey,a,mh,cor=cor,true=3,mr=0,/ps,/nocon,/full,f_c=-1,barf=0.<br>;--------<br>lev=[1,2,4,7,11,16,22,29,37]*0.3+total(mv(0:1))<br>cont_grey,total(fs(*,*,0:1),3),mh,a,cor=cor,true=3,mr=0,/ps,/full,f_c=-1,barf=0.,lev=lev<br>scale='1''<br>scale_plot,cor,mh,0.08,0.93,1,scale,thick=2,char=2,color=!d.n_colors-1<br>s=tvrd(0,0,true=3) &amp; write_jpeg,target+'_rgb_ros_c.jpg',s,true=3<br><br>;======================================================<br>save,file='idlsave_n3556.dat'<br><br>;=========================================================<br>;for reading the evt list only<br>evtroot='evt2file_new_clean' <br>evt_image,evtroot,'acisi',/noexp,/nofits,list=l,xmin=xmin,ymin=ymin,hdr=hh,datadir='../xdata/'<br><br>block=6<br>list_image,l,xmin,ymin,c1,512,block=block,detagname='det',emin=1000,emax=3000<br>list_image,l,xmin,ymin,c,512,block=block,emin=1000,emax=3000<br> list_image,l,xmin,ymin,c,512,block=block<br><br>g2=psf_gaussian(fwhm=2,npix=121,/norm)<br>cm=convolve(c,g2)<br>get_fitshead,cm,mh,hh,del=block*!size_pixel/3600.<br>cont_grey,cm,mh,/noc,cor=cor,greymin=0.1,greymax=10,greyl=2,/full,/def,barf=0,f_c=-1,/ps<br>source_plot,soufile,cor,mh,/fits,probth=probth,psym=6,sym=2<br><br><br>window,xs=1024,ys=1024<br><br>s=defroi(1024,1024)<br>ss=defroi(1024,1024)<br>sb=defroi(1024,1024)<br>help,s,ss,sb<br>print,total(c(s)),total(c(ss))-avg(c(sb))*n_elements(ss)<br>      29696.0      231.602<br>print,(total(c(ss))-avg(c(sb))*n_elements(ss))/total(c(s))<br>  0.00779910<br><br>Very much comparable to the expected readout strip 1.3% for<br>the entire 1024 column.<br>;=========================================================<br>;creating a source regional file (as an example):<br>cenvset,'acisi'<br>soufile='evt2file_new_clean_map70BSH_hr'<br>file_params,'../xdata/evt2file_new_clean.fits',h ;get the fits header<br>sou_fits_reg,h,soufile+'.reg',inf=soufile,flow=0.001 <br>	;sources with cntr &gt; 0.001 are selected<br></pre>
</body>
</html>
